<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LINEA</title>

<style>
body{
  margin:0;
  background:#0b0b0b;
  color:#e5e5e5;
  font-family:system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}
#app{
  max-width:420px;
  height:100vh;
  margin:0 auto;
  background:#111;
  display:flex;
  flex-direction:column;
}

/* header */
#header{
  padding:14px;
  text-align:center;
  background:#1a1a1a;
  border-bottom:1px solid #222;
  font-weight:600;
}

/* screens */
.screen{flex:1;display:none}
.screen.active{display:flex;flex-direction:column}

/* mode */
.modeBtn{
  margin:20px;
  padding:14px;
  font-size:16px;
  background:#1e1e1e;
  border:none;
  border-radius:10px;
  color:#fff;
}

/* chat list */
.chatItem{
  display:flex;
  gap:10px;
  padding:12px;
  border-bottom:1px solid #1f1f1f;
  cursor:pointer;
}
.avatar{
  width:40px;
  height:40px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:600;
  color:#000;
}
.chatInfo{flex:1}
.chatName{font-weight:500}
.chatPreview{font-size:13px;opacity:.7}

/* chat */
#chatHeader{
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px;
  border-bottom:1px solid #222;
}
#messages{
  flex:1;
  padding:12px;
  overflow-y:auto;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.msg{
  max-width:80%;
  padding:10px 12px;
  border-radius:12px;
  font-size:14px;
  line-height:1.4;
}
.you{align-self:flex-end;background:#3a3a3a}
.other{align-self:flex-start;background:#1f1f2f}
.system{align-self:center;font-size:12px;opacity:.6}

#typing{
  padding:6px 12px;
  font-size:12px;
  opacity:.6;
  display:none;
}

#choices{
  padding:10px;
  border-top:1px solid #222;
}
.choice{
  width:100%;
  padding:10px;
  margin-top:6px;
  background:#1e1e1e;
  color:#fff;
  border:none;
  border-radius:8px;
}
</style>
</head>
<body>

<div id="app">
  <div id="header">LINEA</div>

  <!-- MODE -->
  <div id="modeScreen" class="screen active">
    <button class="modeBtn" onclick="setMode('free')">Свободный ввод</button>
    <button class="modeBtn" onclick="setMode('choices')">Готовые ответы</button>
  </div>

  <!-- LIST -->
  <div id="listScreen" class="screen"></div>

  <!-- CHAT -->
  <div id="chatScreen" class="screen">
    <div id="chatHeader">
      <span onclick="back()">←</span>
      <span id="chatTitle"></span>
    </div>
    <div id="messages"></div>
    <div id="typing">печатает…</div>
    <div id="choices"></div>
  </div>
</div>

<script>
/* ===== STATE ===== */
let state = JSON.parse(localStorage.getItem("linea_state")) || {
  act: 1,
  mode: null,
  flags: {}
};

function save(){
  localStorage.setItem("linea_state", JSON.stringify(state));
}

/* ===== DATA ===== */
const chats = {
  archive:{
    name:"Архив",
    color:"#aaa",
    messages:[
      {from:"system",text:"Аккаунт восстановлен."},
      {from:"system",text:"Последний вход: 03:17"}
    ]
  },
  unknown:{
    name:"Неизвестный",
    color:"#ff6b6b",
    messages:[
      {from:"other",text:"Ты всё-таки вернулся."}
    ]
  },
  anya:{
    name:"Аня",
    color:"#6bc5ff",
    messages:[
      {from:"system",text:"2 года назад"},
      {from:"other",text:"Если вдруг прочтёшь — не отвечай им."}
    ]
  }
};

/* ===== ELEMENTS ===== */
const modeScreen=document.getElementById("modeScreen");
const listScreen=document.getElementById("listScreen");
const chatScreen=document.getElementById("chatScreen");
const messagesEl=document.getElementById("messages");
const choicesEl=document.getElementById("choices");
const typingEl=document.getElementById("typing");
const chatTitle=document.getElementById("chatTitle");

/* ===== MODE ===== */
function setMode(m){
  state.mode=m;
  save();
  showList();
}

/* ===== UI ===== */
function showList(){
  modeScreen.classList.remove("active");
  chatScreen.classList.remove("active");
  listScreen.classList.add("active");
  listScreen.innerHTML="";
  Object.keys(chats).forEach(id=>{
    const c=chats[id];
    const div=document.createElement("div");
    div.className="chatItem";
    div.onclick=()=>openChat(id);
    div.innerHTML=`
      <div class="avatar" style="background:${c.color}">${c.name[0]}</div>
      <div class="chatInfo">
        <div class="chatName">${c.name}</div>
        <div class="chatPreview">${c.messages.at(-1).text}</div>
      </div>`;
    listScreen.appendChild(div);
  });
}

function openChat(id){
  listScreen.classList.remove("active");
  chatScreen.classList.add("active");
  messagesEl.innerHTML="";
  choicesEl.innerHTML="";
  typingEl.style.display="none";
  chatTitle.textContent=chats[id].name;
  chats[id].messages.forEach(m=>addMsg(m.text,m.from));
  routeStory(id);
}

function back(){
  chatScreen.classList.remove("active");
  showList();
}

function addMsg(text,from){
  const d=document.createElement("div");
  d.className="msg "+from;
  d.textContent=text;
  messagesEl.appendChild(d);
  messagesEl.scrollTop=messagesEl.scrollHeight;
}

function showTyping(ms){
  typingEl.style.display="block";
  setTimeout(()=>typingEl.style.display="none",ms);
}

function choice(text,fn){
  const b=document.createElement("button");
  b.className="choice";
  b.textContent=text;
  b.onclick=()=>{
    addMsg(text,"you");
    choicesEl.innerHTML="";
    fn();
  };
  choicesEl.appendChild(b);
}

/* ===== STORY ROUTER ===== */
function routeStory(id){
  if(state.act===1) act1(id);
  if(state.act===2) act2(id);
  if(state.act===3) act3(id);
}

/* ===== ACT 1 ===== */
function act1(id){
  if(id==="unknown"){
    choice("Кто ты?",()=>{
      showTyping(1200);
      setTimeout(()=>{
        addMsg("Ты уже задавал этот вопрос.","other");
        addMsg("Это нормально.","other");
      },1200);
    });
    if(state.mode==="choices"){
      choice("…",()=>{
        state.flags.silent=true;
        save();
      });
    }
  }

  if(id==="anya"){
    choice("Кто написал?",()=>{
      showTyping(1000);
      setTimeout(()=>{
        addMsg("Он.","other");
        addMsg("Если он снова активен — всё плохо.","other");
        state.act=2;
        save();
      },1000);
    });
  }
}

/* ===== ACT 2 ===== */
function act2(id){
  if(id==="unknown"){
    addMsg("Ты не помнишь, как всё закончилось?","other");
    showTyping(1400);
    setTimeout(()=>{
      addMsg("Никто не помнит.","other");
    },1400);
  }

  if(id==="archive"){
    addMsg("Зафиксирована активность.","system");
    showTyping(1200);
    setTimeout(()=>{
      addMsg("Некоторые данные могут быть утеряны.","system");
    },1200);
  }

  if(id==="anya"){
    addMsg("Он снова здесь, да?","other");
    choice("Да",()=>{
      addMsg("Тогда не отвечай ему долго.","other");
      state.act=3;
      save();
    });
    if(state.mode==="choices"){
      choice("Не знаю",()=>{
        addMsg("Ты знаешь.","other");
        state.act=3;
        save();
      });
    }
  }
}

/* ===== ACT 3 ===== */
function act3(id){
  if(id==="unknown"){
    addMsg("LINEA не хранит людей.","other");
    showTyping(1200);
    setTimeout(()=>{
      addMsg("Она хранит разговоры.","other");
    },1200);
  }

  if(id==="archive"){
    addMsg("Обнаружено несоответствие данных.","system");
  }

  if(id==="anya"){
    addMsg("Скажи честно.","other");
    addMsg("Это писал ты?","other");
  }
}

/* ===== INIT ===== */
if(state.mode){
  showList();
}
</script>

</body>
</html>
